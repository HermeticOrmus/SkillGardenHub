<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SkillGarden: Illuminate your learning path. Paste an article, see what you can learn, prove what you know.">
  <meta name="theme-color" content="#1B4332">
  <title>SkillGarden -- Knowledge Constellation</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- Skip to content -->
<a href="#tree-section" class="skip-link">Skip to main content</a>

<!-- Navigation -->
<nav class="nav" role="navigation" aria-label="Main navigation">
  <a href="index.html" class="nav-logo">Skill<span>Garden</span></a>
  <ul class="nav-links">
    <li><a href="#tree-section" class="active">Tree</a></li>
    <li><a href="#illuminated-section">Illuminate</a></li>
    <li><a href="#assess-section">Assess</a></li>
    <li><a href="#share-section">Share</a></li>
  </ul>
  <div class="nav-profile">
    <div class="nav-avatar">SG</div>
    <div>
      <div class="nav-name">Explorer</div>
      <div class="nav-level">Knowledge Seeker</div>
    </div>
  </div>
</nav>

<!-- ============================================
     SECTION 1: MASTER TREE (Hero, always visible)
     ============================================ -->
<section class="section constellation-hero" id="tree-section" style="padding-top: calc(var(--space-xl) + 60px);">

  <!-- Input overlay bar -->
  <div class="illuminate-bar reveal">
    <div class="illuminate-bar-inner">
      <h2 class="illuminate-title">The Knowledge Constellation</h2>
      <p class="illuminate-subtitle">Every industry. Every skill. One map. Paste an article to illuminate your learning path.</p>

      <div class="illuminate-input-row">
        <div class="illuminate-source-types">
          <button class="source-chip active" data-type="article">Article</button>
          <button class="source-chip" data-type="youtube">YouTube</button>
          <button class="source-chip" data-type="pdf">PDF</button>
          <button class="source-chip" data-type="topic">Topic</button>
        </div>
        <div class="illuminate-input-group">
          <input type="text" id="illuminateInput" class="illuminate-input" placeholder="Paste an article URL or describe a topic..." autocomplete="off" spellcheck="false" />
          <button id="illuminateBtn" class="illuminate-btn" disabled>
            <span class="illuminate-btn-text">Illuminate</span>
            <svg class="illuminate-btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Loading state -->
      <div id="illuminateLoading" class="illuminate-loading" style="display: none;">
        <div class="spinner"></div>
        <span id="illuminateStatus" class="illuminate-status">Analyzing content against constellation...</span>
      </div>

      <!-- Error state -->
      <div id="illuminateError" class="illuminate-error" style="display: none;"></div>

      <!-- Example chips -->
      <div class="illuminate-examples">
        <span class="examples-label">Try:</span>
        <button class="example-chip" data-topic="The AI Boom in Finance: How Machine Learning is Reshaping Wall Street">AI in Finance</button>
        <button class="example-chip" data-topic="CRISPR Gene Editing and the Future of Personalized Medicine">CRISPR & Medicine</button>
        <button class="example-chip" data-topic="The Global Energy Transition: Solar, Wind, and the Path to Net Zero">Energy Transition</button>
        <button class="example-chip" data-topic="How Game Design Principles are Transforming Education and Learning">Gamified Learning</button>
      </div>
    </div>
  </div>

  <!-- Tree stats (hidden until loaded) -->
  <div id="treeStatsBar" class="tree-stats-bar reveal" style="display: none;"></div>

  <!-- Master Tree Canvas -->
  <div id="masterTreeContainer" class="skill-tree-canvas-container constellation-canvas reveal">
    <canvas id="masterTreeCanvas" aria-label="Interactive master knowledge constellation spanning all major industries"></canvas>
    <div id="masterTreeLegend" class="tree-legend"></div>
  </div>
</section>

<!-- ============================================
     SECTION 2: ILLUMINATED VIEW (after article mapping)
     ============================================ -->
<section class="section" id="illuminated-section" style="display: none; background: var(--warm-white);">
  <div class="illumination-results reveal">
    <div class="illumination-header">
      <div class="illumination-info">
        <h2 id="illuminationTitle">Illuminated Path</h2>
        <p id="illuminationSummary" class="illumination-summary"></p>
      </div>
      <div class="illumination-stats">
        <div class="illumination-stat">
          <span id="litCount" class="illumination-stat-val">0</span>
          <span class="illumination-stat-label">Nodes Lit</span>
        </div>
        <div class="illumination-stat">
          <span id="totalCount" class="illumination-stat-val">0</span>
          <span class="illumination-stat-label">Total Nodes</span>
        </div>
        <div class="illumination-stat">
          <span id="clusterCount" class="illumination-stat-val">0</span>
          <span class="illumination-stat-label">Clusters</span>
        </div>
      </div>
    </div>

    <!-- Illuminated clusters list -->
    <div id="illuminatedClusters" class="illuminated-clusters"></div>

    <!-- Actions -->
    <div class="illumination-actions">
      <button id="assessBtn" class="illumination-cta">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
        </svg>
        Assess My Knowledge
      </button>
      <button id="resetBtn" class="illumination-reset">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
        </svg>
        Reset Constellation
      </button>
    </div>
  </div>
</section>

<!-- ============================================
     SECTION 3: ASSESSMENT
     ============================================ -->
<section class="section" id="assess-section" style="display: none;">
  <div class="section-header">
    <h2>Knowledge Assessment</h2>
    <p id="assessSubtitle">Testing your understanding of the illuminated nodes</p>
  </div>

  <!-- Assessment loading -->
  <div id="assessLoading" class="assess-loading" style="display: none;">
    <div class="spinner"></div>
    <span class="assess-loading-text">Generating assessment for illuminated areas...</span>
  </div>

  <!-- Assessment content (quiz questions injected here) -->
  <div id="assessContent" style="display: none;">
    <div class="assess-progress">
      <div class="assess-progress-bar">
        <div id="assessProgressFill" class="assess-progress-fill" style="width: 0%;"></div>
      </div>
      <span id="assessProgressText" class="assess-progress-text">Question 1 of 18</span>
    </div>

    <div id="assessQuestionCard" class="assessment-card">
      <!-- Question injected dynamically -->
    </div>

    <div class="assess-nav">
      <button id="assessPrev" class="assess-nav-btn" disabled>Previous</button>
      <button id="assessNext" class="assess-nav-btn assess-nav-primary">Next</button>
      <button id="assessSubmit" class="assess-nav-btn assess-nav-submit" style="display: none;">Submit Assessment</button>
    </div>
  </div>

  <!-- Assessment results -->
  <div id="assessResults" style="display: none;">
    <div class="assess-results-card">
      <div class="assess-results-header">
        <h3>Assessment Complete</h3>
        <div class="assess-results-level">
          <span id="resultLevel" class="result-level-num">0</span>
          <span id="resultTier" class="result-level-tier">Novice</span>
        </div>
      </div>
      <div id="resultBreakdown" class="result-breakdown"></div>
      <div class="result-actions">
        <button id="shareResultBtn" class="illumination-cta">Share Credential</button>
        <button id="retakeBtn" class="illumination-reset">Retake Assessment</button>
      </div>
    </div>
  </div>
</section>

<!-- ============================================
     SECTION 4: SHARE / CREDENTIAL
     ============================================ -->
<section class="section" id="share-section" style="display: none; background: var(--warm-white);">
  <div class="section-header" style="text-align: center;">
    <h2>Your Knowledge Credential</h2>
    <p>Verified through structured assessment, not self-reporting</p>
  </div>

  <div class="credential-section">
    <div class="credential-card" id="credentialCard">
      <div class="credential-top">
        <div class="credential-top-label">SkillGarden Verified Skill Credential</div>
        <div class="credential-top-name" id="credentialName">Explorer</div>
      </div>
      <div class="credential-body">
        <div class="credential-skill-main">
          <div>
            <div class="credential-skill-name" id="credentialTopic">--</div>
            <div id="credentialMeta" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;"></div>
          </div>
          <div class="credential-level">
            <div class="credential-level-num" id="credentialLevel">--</div>
            <div class="credential-level-tier" id="credentialTier">--</div>
          </div>
        </div>

        <div id="credentialNodes" class="credential-sub-skills"></div>

        <div class="credential-verification">
          <h4>How This Was Earned</h4>
          <div class="verification-item">
            <span class="verification-check">&#10003;</span> AI-generated assessment (not self-reported)
          </div>
          <div class="verification-item">
            <span class="verification-check">&#10003;</span> Bloom's taxonomy progression (recall to synthesis)
          </div>
          <div class="verification-item">
            <span class="verification-check">&#10003;</span> Exponential XP curve (Level 92 = halfway to 99)
          </div>
        </div>

        <div class="credential-footer">
          <span class="credential-id" id="credentialId">SG-2026-XXXX</span>
          <span class="credential-verify-link">skillgarden.vercel.app</span>
        </div>
      </div>
    </div>
  </div>

  <div style="text-align: center; margin-top: var(--space-xl);">
    <button id="shareBtn" class="illumination-cta">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
      </svg>
      Copy Share Link
    </button>
  </div>
</section>

<!-- Footer -->
<footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-logo">Skill<span>Garden</span></div>
    <div class="footer-team">
      <span>Diego</span>
      <span>Yavuz</span>
      <span>Jess</span>
      <span>Josue</span>
      <span>Ethan</span>
    </div>
    <p class="footer-event">Iterate x CBS AI Club Valentine Hackathon 2026</p>
  </div>
</footer>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Config & XP System -->
<script src="config.js"></script>

<!-- Services -->
<script src="services/supabase-client.js"></script>
<script src="services/blaxel-client.js"></script>

<!-- Dynamic Skill Tree Renderer -->
<script src="dynamic-tree.js"></script>

<!-- Scroll reveal (minimal from app.js) -->
<script>
(function() {
  'use strict';
  // Scroll reveal
  var observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.08 });
  document.querySelectorAll('.reveal').forEach(function(el) { observer.observe(el); });

  // Smooth scroll nav
  document.querySelectorAll('.nav-links a').forEach(function(link) {
    link.addEventListener('click', function(e) {
      var href = link.getAttribute('href');
      if (href && href.startsWith('#')) {
        e.preventDefault();
        var target = document.querySelector(href);
        if (target) {
          var nav = document.querySelector('.nav');
          var offset = nav ? nav.offsetHeight : 60;
          window.scrollTo({ top: target.offsetTop - offset - 16, behavior: 'smooth' });
        }
        document.querySelectorAll('.nav-links a').forEach(function(l) { l.classList.remove('active'); });
        link.classList.add('active');
      }
    });
  });

  // Nav background on scroll
  window.addEventListener('scroll', function() {
    var nav = document.querySelector('.nav');
    if (nav) {
      nav.style.backdropFilter = window.scrollY > 40 ? 'blur(12px)' : 'none';
    }
  });
})();
</script>

<!-- Inline styles for new components -->
<style>
  .spinner {
    width: 24px; height: 24px;
    border: 3px solid var(--border);
    border-top-color: var(--deep-forest);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Constellation hero */
  .constellation-hero {
    padding-bottom: var(--space-lg);
  }
  .constellation-canvas {
    min-height: 500px;
  }
  .constellation-canvas canvas {
    min-height: 500px;
  }

  /* Illuminate bar */
  .illuminate-bar {
    background: var(--card-bg);
    border: 2px solid var(--border);
    border-radius: var(--radius-xl);
    padding: var(--space-2xl) var(--space-xl);
    text-align: center;
    margin-bottom: var(--space-lg);
    position: relative;
    overflow: hidden;
  }
  .illuminate-bar::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--deep-forest), var(--tier-adept), var(--tier-expert), var(--sage-green));
  }
  .illuminate-bar-inner {
    max-width: 720px;
    margin: 0 auto;
  }
  .illuminate-title {
    font-family: var(--font-heading);
    font-size: 1.6rem;
    font-weight: 800;
    color: var(--deep-forest);
    margin-bottom: var(--space-xs);
    letter-spacing: -0.02em;
  }
  .illuminate-subtitle {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: var(--space-lg);
  }

  /* Source chips */
  .illuminate-source-types {
    display: flex;
    gap: var(--space-xs);
    justify-content: center;
    margin-bottom: var(--space-md);
  }
  .source-chip {
    padding: var(--space-xs) var(--space-md);
    border: 1.5px solid var(--border);
    border-radius: 20px;
    background: var(--card-bg);
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
  }
  .source-chip:hover { border-color: var(--sage-green); color: var(--text-primary); }
  .source-chip.active {
    border-color: var(--deep-forest);
    background: rgba(27, 67, 50, 0.06);
    color: var(--deep-forest);
    font-weight: 600;
  }

  /* Input group */
  .illuminate-input-group {
    display: flex;
    gap: var(--space-sm);
  }
  .illuminate-input {
    flex: 1;
    padding: var(--space-md) var(--space-lg);
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    font-family: var(--font-body);
    font-size: 0.95rem;
    color: var(--text-primary);
    background: var(--card-bg);
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .illuminate-input:focus {
    border-color: var(--deep-forest);
    box-shadow: 0 0 0 3px rgba(27, 67, 50, 0.1);
  }
  .illuminate-input::placeholder { color: var(--text-muted); }
  .illuminate-btn {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-xl);
    background: var(--deep-forest);
    color: var(--warm-white);
    border: none;
    border-radius: var(--radius-lg);
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .illuminate-btn:hover:not(:disabled) {
    background: var(--sage-green);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(27, 67, 50, 0.2);
  }
  .illuminate-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .illuminate-btn-icon { display: flex; }

  /* Loading / Error */
  .illuminate-loading {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    justify-content: center;
    margin-top: var(--space-md);
  }
  .illuminate-status {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
  }
  .illuminate-error {
    margin-top: var(--space-md);
    padding: var(--space-md);
    background: rgba(211, 47, 47, 0.07);
    border-left: 3px solid #D32F2F;
    border-radius: var(--radius-md);
    font-size: 0.85rem;
    color: #D32F2F;
    text-align: left;
  }
  .illuminate-examples {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex-wrap: wrap;
    justify-content: center;
    margin-top: var(--space-lg);
  }

  /* Tree stats bar */
  .tree-stats-bar {
    display: flex;
    gap: var(--space-md);
    justify-content: center;
    margin-bottom: var(--space-md);
    flex-wrap: wrap;
  }

  /* Illumination results */
  .illumination-results {
    max-width: 900px;
    margin: 0 auto;
  }
  .illumination-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-xl);
    margin-bottom: var(--space-xl);
  }
  .illumination-info h2 {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    color: var(--deep-forest);
    margin-bottom: var(--space-xs);
  }
  .illumination-summary {
    color: var(--text-secondary);
    font-size: 0.9rem;
    line-height: 1.6;
  }
  .illumination-stats {
    display: flex;
    gap: var(--space-lg);
    flex-shrink: 0;
  }
  .illumination-stat {
    text-align: center;
  }
  .illumination-stat-val {
    display: block;
    font-family: var(--font-mono);
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--deep-forest);
  }
  .illumination-stat-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Illuminated clusters */
  .illuminated-clusters {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
  }
  .lit-cluster-card {
    background: var(--card-bg);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
  }
  .lit-cluster-name {
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 0.85rem;
    margin-bottom: var(--space-xs);
  }
  .lit-cluster-nodes {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--text-muted);
  }
  .lit-node-tag {
    display: inline-block;
    padding: 2px 8px;
    margin: 2px;
    border-radius: 10px;
    font-size: 0.68rem;
    color: white;
    font-family: var(--font-mono);
  }

  /* Actions */
  .illumination-actions {
    display: flex;
    gap: var(--space-md);
    align-items: center;
  }
  .illumination-cta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-xl);
    background: var(--deep-forest);
    color: var(--warm-white);
    border: none;
    border-radius: var(--radius-md);
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .illumination-cta:hover {
    background: var(--sage-green);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(27, 67, 50, 0.2);
  }
  .illumination-reset {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-lg);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-md);
    background: var(--card-bg);
    font-family: var(--font-heading);
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
  }
  .illumination-reset:hover {
    border-color: var(--deep-forest);
    color: var(--deep-forest);
  }

  /* Assessment */
  .assess-loading {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    justify-content: center;
    padding: var(--space-3xl) 0;
  }
  .assess-loading-text {
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--text-muted);
  }
  .assess-progress {
    margin-bottom: var(--space-xl);
  }
  .assess-progress-bar {
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: var(--space-xs);
  }
  .assess-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--deep-forest), var(--sage-green));
    border-radius: 3px;
    transition: width 0.3s;
  }
  .assess-progress-text {
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--text-muted);
  }
  .assess-nav {
    display: flex;
    justify-content: space-between;
    margin-top: var(--space-lg);
  }
  .assess-nav-btn {
    padding: var(--space-sm) var(--space-xl);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-md);
    background: var(--card-bg);
    font-family: var(--font-heading);
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
  }
  .assess-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .assess-nav-btn:hover:not(:disabled) { border-color: var(--deep-forest); color: var(--deep-forest); }
  .assess-nav-primary {
    background: var(--deep-forest);
    color: var(--warm-white);
    border-color: var(--deep-forest);
  }
  .assess-nav-primary:hover:not(:disabled) { background: var(--sage-green); color: var(--warm-white); border-color: var(--sage-green); }
  .assess-nav-submit {
    background: var(--tier-expert);
    color: white;
    border-color: var(--tier-expert);
  }
  .assess-nav-submit:hover:not(:disabled) { background: var(--tier-master); border-color: var(--tier-master); color: white; }

  /* Results */
  .assess-results-card {
    background: var(--card-bg);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border);
    overflow: hidden;
    max-width: 600px;
    margin: 0 auto;
  }
  .assess-results-header {
    background: var(--deep-forest);
    color: var(--warm-white);
    padding: var(--space-xl);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .assess-results-header h3 {
    font-family: var(--font-heading);
    font-size: 1.2rem;
  }
  .result-level-num {
    font-family: var(--font-mono);
    font-size: 2.2rem;
    font-weight: 700;
  }
  .result-level-tier {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.7;
  }
  .result-breakdown {
    padding: var(--space-xl);
  }
  .result-cluster-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) 0;
    border-bottom: 1px solid rgba(226, 232, 240, 0.5);
  }
  .result-cluster-row:last-child { border-bottom: none; }
  .result-cluster-name {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }
  .result-cluster-score {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    font-weight: 600;
  }
  .result-actions {
    padding: 0 var(--space-xl) var(--space-xl);
    display: flex;
    gap: var(--space-md);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .illuminate-input-group { flex-direction: column; }
    .illuminate-btn { width: 100%; justify-content: center; }
    .illumination-header { flex-direction: column; }
    .illumination-stats { justify-content: flex-start; }
    .illumination-actions { flex-direction: column; }
    .illumination-cta, .illumination-reset { width: 100%; justify-content: center; }
    .assess-results-header { flex-direction: column; gap: var(--space-md); }
    .result-actions { flex-direction: column; }
  }
</style>

<!-- ============================================
     MAIN APPLICATION LOGIC
     ============================================ -->
<script>
(function() {
  'use strict';

  // --- State ---
  var masterTree = null;
  var illuminatedNodeIds = [];
  var assessmentData = null;
  var currentQuestion = 0;
  var userAnswers = {};

  // --- DOM refs ---
  var illuminateInput = document.getElementById('illuminateInput');
  var illuminateBtn = document.getElementById('illuminateBtn');
  var loadingEl = document.getElementById('illuminateLoading');
  var statusEl = document.getElementById('illuminateStatus');
  var errorEl = document.getElementById('illuminateError');

  var illuminatedSection = document.getElementById('illuminated-section');
  var assessSection = document.getElementById('assess-section');
  var shareSection = document.getElementById('share-section');
  var treeStatsBar = document.getElementById('treeStatsBar');

  // --- Load master tree on page load ---
  fetch('data/master-tree.json')
    .then(function(res) { return res.json(); })
    .then(function(data) {
      masterTree = data;
      // Show stats
      treeStatsBar.style.display = '';
      treeStatsBar.innerHTML =
        '<div class="stat-pill"><span class="stat-pill-val">' + data.nodes.length + '</span> Nodes</div>' +
        '<div class="stat-pill"><span class="stat-pill-val">' + data.clusters.length + '</span> Industries</div>' +
        '<div class="stat-pill"><span class="stat-pill-val">' + data.connections.length + '</span> Connections</div>';

      // Render the full constellation
      DynamicTree.init('masterTreeCanvas', 'masterTreeLegend', data);
    })
    .catch(function(err) {
      console.error('Failed to load master tree:', err);
      showError('Failed to load master constellation. Check that data/master-tree.json exists.');
    });

  // --- Source type selector ---
  document.querySelectorAll('.source-chip').forEach(function(chip) {
    chip.addEventListener('click', function() {
      document.querySelectorAll('.source-chip').forEach(function(c) { c.classList.remove('active'); });
      chip.classList.add('active');
      var placeholders = {
        article: 'Paste an article URL...',
        youtube: 'Paste a YouTube video URL...',
        pdf: 'Paste a PDF URL...',
        topic: 'Describe any topic you want to explore...',
      };
      illuminateInput.placeholder = placeholders[chip.dataset.type] || placeholders.article;
      illuminateInput.focus();
    });
  });

  // --- Enable/disable button ---
  illuminateInput.addEventListener('input', function() {
    illuminateBtn.disabled = illuminateInput.value.trim().length < 3;
  });

  // --- Example chips ---
  document.querySelectorAll('.example-chip').forEach(function(chip) {
    chip.addEventListener('click', function() {
      illuminateInput.value = chip.dataset.topic;
      illuminateInput.dispatchEvent(new Event('input'));
      document.querySelectorAll('.source-chip').forEach(function(c) { c.classList.remove('active'); });
      var topicChip = document.querySelector('.source-chip[data-type="topic"]');
      if (topicChip) topicChip.classList.add('active');
    });
  });

  // --- UI helpers ---
  function setLoading(on) {
    illuminateBtn.disabled = on;
    loadingEl.style.display = on ? 'flex' : 'none';
    illuminateBtn.style.opacity = on ? '0.6' : '1';
  }
  function setStatus(msg) { if (statusEl) statusEl.textContent = msg; }
  function showError(msg) {
    errorEl.textContent = msg;
    errorEl.style.display = msg ? 'block' : 'none';
  }
  function clearError() { showError(''); }

  function scrollTo(el) {
    if (!el) return;
    var nav = document.querySelector('.nav');
    var offset = nav ? nav.offsetHeight : 60;
    window.scrollTo({ top: el.offsetTop - offset - 16, behavior: 'smooth' });
  }

  // --- Illuminate handler ---
  function handleIlluminate() {
    var topic = illuminateInput.value.trim();
    if (!topic || !masterTree) return;

    clearError();
    setLoading(true);
    setStatus('Analyzing content against constellation...');

    // Try Blaxel agent for article mapping
    BlaxelClient.mapArticleToTree(topic, masterTree.nodes)
      .then(function(result) {
        if (!result.success || !result.illuminated || result.illuminated.length === 0) {
          throw new Error('No nodes matched this article. Try a broader topic.');
        }
        setStatus('Illuminating nodes...');
        applyIllumination(result.illuminated, result.summary || '', result.clusters_touched || [], topic);
        setLoading(false);
      })
      .catch(function(err) {
        console.warn('[SkillGarden] Blaxel mapping failed, using client-side fallback:', err.message);
        setStatus('Using local mapping...');
        // Client-side keyword fallback
        var fallback = localMapArticle(topic);
        if (fallback.illuminated.length > 0) {
          applyIllumination(fallback.illuminated, fallback.summary, fallback.clusters_touched, topic);
          setLoading(false);
        } else {
          setLoading(false);
          showError('Could not map this article to the constellation. ' + err.message);
        }
      });
  }

  // --- Client-side keyword mapping (fallback) ---
  function localMapArticle(topic) {
    var lowerTopic = topic.toLowerCase();
    var illuminated = [];
    var clustersTouched = new Set();

    masterTree.nodes.forEach(function(node) {
      var label = (node.label || '').toLowerCase();
      var desc = (node.description || '').toLowerCase();
      var cluster = (node.cluster || '').toLowerCase();

      // Simple keyword match: check if any word in the topic appears in node label/desc
      var topicWords = lowerTopic.split(/\s+/).filter(function(w) { return w.length > 3; });
      var matches = topicWords.filter(function(w) {
        return label.indexOf(w) >= 0 || desc.indexOf(w) >= 0;
      });

      if (matches.length >= 1) {
        illuminated.push(node.id);
        clustersTouched.add(node.cluster);
      }
    });

    // If too few matches, add related nodes via connections
    if (illuminated.length < 5 && illuminated.length > 0) {
      var idSet = new Set(illuminated);
      masterTree.connections.forEach(function(conn) {
        if (idSet.has(conn[0]) && !idSet.has(conn[1])) {
          illuminated.push(conn[1]);
          var n = masterTree.nodes.find(function(x) { return x.id === conn[1]; });
          if (n) clustersTouched.add(n.cluster);
        }
        if (idSet.has(conn[1]) && !idSet.has(conn[0])) {
          illuminated.push(conn[0]);
          var n2 = masterTree.nodes.find(function(x) { return x.id === conn[0]; });
          if (n2) clustersTouched.add(n2.cluster);
        }
      });
    }

    return {
      illuminated: illuminated,
      summary: 'Local keyword mapping for: ' + topic.substring(0, 60),
      clusters_touched: Array.from(clustersTouched)
    };
  }

  // --- Apply illumination to tree and UI ---
  function applyIllumination(nodeIds, summary, clustersTouched, topic) {
    illuminatedNodeIds = nodeIds;

    // Illuminate tree
    DynamicTree.illuminate(nodeIds);

    // Update illumination section
    document.getElementById('illuminationTitle').textContent = topic.substring(0, 80);
    document.getElementById('illuminationSummary').textContent = summary;
    document.getElementById('litCount').textContent = nodeIds.length;
    document.getElementById('totalCount').textContent = masterTree.nodes.length;
    document.getElementById('clusterCount').textContent = clustersTouched.length || countClusters(nodeIds);

    // Build cluster breakdown
    var clusterGroups = {};
    nodeIds.forEach(function(nid) {
      var node = masterTree.nodes.find(function(n) { return n.id === nid; });
      if (!node) return;
      if (!clusterGroups[node.cluster]) clusterGroups[node.cluster] = [];
      clusterGroups[node.cluster].push(node);
    });

    var TIER_COLORS = {
      novice: '#8D6E63', apprentice: '#78909C', journeyman: '#43A047',
      adept: '#1E88E5', expert: '#AB47BC', master: '#FF8F00', grandmaster: '#D32F2F'
    };

    var clustersHTML = '';
    Object.keys(clusterGroups).forEach(function(cid) {
      var cluster = masterTree.clusters.find(function(c) { return c.id === cid; });
      var nodes = clusterGroups[cid];
      var nodesHTML = nodes.map(function(n) {
        return '<span class="lit-node-tag" style="background:' + (TIER_COLORS[n.tier] || '#666') + ';">' + n.label + '</span>';
      }).join('');
      clustersHTML += '<div class="lit-cluster-card">' +
        '<div class="lit-cluster-name">' + (cluster ? cluster.label : cid) + '</div>' +
        '<div class="lit-cluster-nodes">' + nodesHTML + '</div>' +
        '</div>';
    });
    document.getElementById('illuminatedClusters').innerHTML = clustersHTML;

    // Show illuminated section
    illuminatedSection.style.display = '';
    scrollTo(illuminatedSection);
  }

  function countClusters(nodeIds) {
    var clusters = new Set();
    nodeIds.forEach(function(nid) {
      var node = masterTree.nodes.find(function(n) { return n.id === nid; });
      if (node) clusters.add(node.cluster);
    });
    return clusters.size;
  }

  // --- Reset ---
  function handleReset() {
    DynamicTree.resetIllumination();
    DynamicTree.resetValidation();
    illuminatedNodeIds = [];
    illuminatedSection.style.display = 'none';
    assessSection.style.display = 'none';
    shareSection.style.display = 'none';
    scrollTo(document.getElementById('tree-section'));
  }

  // --- Assessment flow ---
  function handleAssess() {
    assessSection.style.display = '';
    scrollTo(assessSection);

    var assessLoading = document.getElementById('assessLoading');
    var assessContent = document.getElementById('assessContent');
    var assessResults = document.getElementById('assessResults');

    assessLoading.style.display = 'flex';
    assessContent.style.display = 'none';
    assessResults.style.display = 'none';

    // Get illuminated node names for context
    var illuminatedNodes = illuminatedNodeIds.map(function(nid) {
      return masterTree.nodes.find(function(n) { return n.id === nid; });
    }).filter(Boolean);

    var focusClusters = [];
    var seen = {};
    illuminatedNodes.forEach(function(n) {
      if (!seen[n.cluster]) {
        focusClusters.push(n.cluster);
        seen[n.cluster] = true;
      }
    });

    var topic = document.getElementById('illuminationTitle').textContent;

    // Try Blaxel pre-test agent
    var preTestUrl = CONFIG.blaxel.skillTreeUrl.replace('sg-skill-tree-maker', 'sg-pre-test-creator').replace(/\/$/, '');

    fetch(preTestUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Blaxel-Workspace': CONFIG.blaxel.workspace,
        'X-Blaxel-Authorization': 'Bearer ' + CONFIG.blaxel.apiKey,
      },
      body: JSON.stringify({
        topic: topic,
        skill_tree: {
          clusters: masterTree.clusters.filter(function(c) { return focusClusters.indexOf(c.id) >= 0; }),
          nodes: illuminatedNodes
        },
        focus_clusters: focusClusters
      })
    })
      .then(function(res) {
        if (!res.ok) throw new Error('Pre-test agent returned ' + res.status);
        return res.json();
      })
      .then(function(data) {
        if (data.success && data.pre_test && data.pre_test.questions) {
          assessmentData = data.pre_test;
          renderAssessment();
        } else {
          throw new Error('Invalid pre-test response');
        }
      })
      .catch(function(err) {
        console.warn('[SkillGarden] Pre-test agent failed, generating mock assessment:', err.message);
        // Generate a mock assessment for demo
        assessmentData = generateMockAssessment(topic, illuminatedNodes, focusClusters);
        renderAssessment();
      });
  }

  // --- Mock assessment generator (client-side fallback) ---
  function generateMockAssessment(topic, illuminatedNodes, focusClusters) {
    var tiers = ['novice', 'novice', 'novice', 'apprentice', 'apprentice', 'apprentice',
                 'journeyman', 'journeyman', 'journeyman', 'adept', 'adept', 'adept',
                 'expert', 'expert', 'expert', 'master', 'master', 'grandmaster'];
    var blooms = [1,1,1, 2,2,2, 3,3,3, 4,4,4, 5,5,5, 6,6, 6];
    var bloomVerbs = ['Define', 'Explain', 'Describe', 'Compare', 'Contrast', 'Apply',
                      'Use', 'Demonstrate', 'Analyze', 'Examine', 'Evaluate', 'Critique',
                      'Design', 'Create', 'Synthesize', 'Propose', 'Construct', 'Theorize'];

    var questions = tiers.map(function(tier, i) {
      var node = illuminatedNodes[i % illuminatedNodes.length];
      var verb = bloomVerbs[i];
      return {
        id: 'q' + (i + 1),
        text: verb + ': What is the significance of ' + node.label + ' in the context of ' + topic + '?',
        tier: tier,
        bloom_level: blooms[i],
        cluster: node.cluster,
        type: 'multiple_choice',
        options: [
          'A) It is a foundational concept that enables deeper understanding',
          'B) It is only relevant in theoretical contexts',
          'C) It has been superseded by newer approaches',
          'D) It is primarily a historical artifact'
        ],
        correct: 'A',
        explanation: node.label + ' is a key building block in the ' + node.cluster + ' domain.'
      };
    });

    return {
      topic: topic,
      questions: questions,
      scoring: {
        novice: { min_correct: 0, max_correct: 2, level_range: [1, 15] },
        apprentice: { min_correct: 3, max_correct: 5, level_range: [16, 30] },
        journeyman: { min_correct: 6, max_correct: 8, level_range: [31, 50] },
        adept: { min_correct: 9, max_correct: 11, level_range: [51, 70] },
        expert: { min_correct: 12, max_correct: 14, level_range: [71, 85] },
        master: { min_correct: 15, max_correct: 16, level_range: [86, 92] },
        grandmaster: { min_correct: 17, max_correct: 18, level_range: [93, 99] }
      },
      clusters_tested: focusClusters
    };
  }

  // --- Render assessment questions ---
  function renderAssessment() {
    document.getElementById('assessLoading').style.display = 'none';
    document.getElementById('assessContent').style.display = '';
    document.getElementById('assessResults').style.display = 'none';

    currentQuestion = 0;
    userAnswers = {};
    showQuestion(0);
  }

  function showQuestion(index) {
    var q = assessmentData.questions[index];
    if (!q) return;

    currentQuestion = index;
    var total = assessmentData.questions.length;

    // Update progress
    document.getElementById('assessProgressFill').style.width = ((index + 1) / total * 100) + '%';
    document.getElementById('assessProgressText').textContent = 'Question ' + (index + 1) + ' of ' + total;

    // Build question card
    var bloomLabels = ['', 'Remember', 'Understand', 'Apply', 'Analyze', 'Evaluate', 'Create'];
    var tierName = q.tier.charAt(0).toUpperCase() + q.tier.slice(1);

    var optionsHTML = '';
    if (q.options) {
      optionsHTML = q.options.map(function(opt, i) {
        var letter = String.fromCharCode(65 + i);
        var selected = userAnswers[q.id] === letter ? ' selected' : '';
        return '<div class="assessment-option' + selected + '" data-answer="' + letter + '" role="button" tabindex="0">' + opt + '</div>';
      }).join('');
    }

    document.getElementById('assessQuestionCard').innerHTML =
      '<div class="assessment-header">' +
        '<span class="assessment-type">' + tierName + '</span>' +
        '<span class="assessment-bloom">Bloom L' + q.bloom_level + ': ' + (bloomLabels[q.bloom_level] || '') + '</span>' +
      '</div>' +
      '<div class="assessment-body">' +
        '<div class="assessment-question">' + q.text + '</div>' +
        '<div class="assessment-options">' + optionsHTML + '</div>' +
      '</div>';

    // Wire up option click handlers
    document.querySelectorAll('#assessQuestionCard .assessment-option').forEach(function(opt) {
      opt.addEventListener('click', function() {
        document.querySelectorAll('#assessQuestionCard .assessment-option').forEach(function(o) { o.classList.remove('selected'); });
        opt.classList.add('selected');
        userAnswers[q.id] = opt.dataset.answer;
      });
    });

    // Nav buttons
    document.getElementById('assessPrev').disabled = index === 0;
    document.getElementById('assessNext').style.display = index < total - 1 ? '' : 'none';
    document.getElementById('assessSubmit').style.display = index === total - 1 ? '' : 'none';
  }

  // --- Assessment navigation ---
  document.getElementById('assessPrev').addEventListener('click', function() {
    if (currentQuestion > 0) showQuestion(currentQuestion - 1);
  });
  document.getElementById('assessNext').addEventListener('click', function() {
    if (currentQuestion < assessmentData.questions.length - 1) showQuestion(currentQuestion + 1);
  });
  document.getElementById('assessSubmit').addEventListener('click', function() {
    submitAssessment();
  });

  // --- Submit and score ---
  function submitAssessment() {
    var correct = 0;
    var clusterScores = {};

    assessmentData.questions.forEach(function(q) {
      var isCorrect = userAnswers[q.id] === q.correct;
      if (isCorrect) correct++;

      if (!clusterScores[q.cluster]) clusterScores[q.cluster] = { correct: 0, total: 0 };
      clusterScores[q.cluster].total++;
      if (isCorrect) clusterScores[q.cluster].correct++;
    });

    // Determine tier and level
    var scoring = assessmentData.scoring;
    var resultTier = 'novice';
    var resultLevel = 5;
    Object.keys(scoring).forEach(function(tier) {
      var s = scoring[tier];
      if (correct >= s.min_correct && correct <= s.max_correct) {
        resultTier = tier;
        var range = s.level_range;
        var pct = (correct - s.min_correct) / Math.max(1, s.max_correct - s.min_correct);
        resultLevel = Math.round(range[0] + pct * (range[1] - range[0]));
      } else if (correct > s.max_correct) {
        resultTier = tier;
        resultLevel = s.level_range[1];
      }
    });

    // Show results
    document.getElementById('assessContent').style.display = 'none';
    document.getElementById('assessResults').style.display = '';

    var tierInfo = getTierForLevel(resultLevel);
    document.getElementById('resultLevel').textContent = resultLevel;
    document.getElementById('resultLevel').style.color = tierInfo.color;
    document.getElementById('resultTier').textContent = tierInfo.name;
    document.getElementById('resultTier').style.color = tierInfo.color;

    // Cluster breakdown
    var breakdownHTML = '';
    Object.keys(clusterScores).forEach(function(cid) {
      var cs = clusterScores[cid];
      var pct = Math.round(cs.correct / cs.total * 100);
      var cluster = masterTree.clusters.find(function(c) { return c.id === cid; });
      breakdownHTML += '<div class="result-cluster-row">' +
        '<span class="result-cluster-name">' + (cluster ? cluster.label : cid) + '</span>' +
        '<span class="result-cluster-score">' + cs.correct + '/' + cs.total + ' (' + pct + '%)</span>' +
        '</div>';
    });
    document.getElementById('resultBreakdown').innerHTML = breakdownHTML;

    // Store for credential
    window._assessResult = {
      level: resultLevel,
      tier: resultTier,
      tierInfo: tierInfo,
      correct: correct,
      total: assessmentData.questions.length,
      clusterScores: clusterScores,
      topic: assessmentData.topic || document.getElementById('illuminationTitle').textContent
    };

    // Validate illuminated nodes on the tree -- now they get tier colors + levels
    var validationData = {};
    illuminatedNodeIds.forEach(function(nid) {
      validationData[nid] = { tier: resultTier, level: resultLevel };
    });
    // Per-cluster levels for more granular coloring
    Object.keys(clusterScores).forEach(function(cid) {
      var cs = clusterScores[cid];
      var clusterPct = cs.correct / Math.max(1, cs.total);
      var clusterLevel = Math.max(1, Math.round(clusterPct * resultLevel));
      var clusterTierInfo = getTierForLevel(clusterLevel);
      illuminatedNodeIds.forEach(function(nid) {
        var node = masterTree.nodes.find(function(n) { return n.id === nid; });
        if (node && node.cluster === cid) {
          validationData[nid] = { tier: clusterTierInfo.name.toLowerCase(), level: clusterLevel };
        }
      });
    });
    DynamicTree.validate(validationData);

    // Show share section
    shareSection.style.display = '';
    populateCredential(window._assessResult);
  }

  // --- Populate credential card ---
  function populateCredential(result) {
    document.getElementById('credentialTopic').textContent = result.topic;
    document.getElementById('credentialLevel').textContent = result.level;
    document.getElementById('credentialLevel').style.color = result.tierInfo.color;
    document.getElementById('credentialTier').textContent = result.tierInfo.name;
    document.getElementById('credentialTier').style.color = result.tierInfo.color;
    document.getElementById('credentialMeta').textContent =
      result.correct + '/' + result.total + ' correct -- ' + illuminatedNodeIds.length + ' nodes assessed';

    // Generate credential ID
    var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    var id = 'SG-2026-';
    for (var i = 0; i < 5; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
    document.getElementById('credentialId').textContent = id;

    // Illuminated node list
    var nodesHTML = '';
    illuminatedNodeIds.slice(0, 8).forEach(function(nid, i) {
      var node = masterTree.nodes.find(function(n) { return n.id === nid; });
      if (!node) return;
      var prefix = i < illuminatedNodeIds.length - 1 ? '&#9500;&#9472;' : '&#9492;&#9472;';
      var tierInfo = getTierForLevel(node.level_range ? node.level_range[0] : 1);
      nodesHTML += '<div class="credential-sub-skill">' +
        '<span class="credential-sub-name"><span style="color: var(--text-muted); margin-right: 4px;">' + prefix + '</span>' + node.label + '</span>' +
        '<span class="credential-sub-level" style="color:' + tierInfo.color + ';">' + node.tier + '</span>' +
        '</div>';
    });
    if (illuminatedNodeIds.length > 8) {
      nodesHTML += '<div class="credential-sub-skill"><span class="credential-sub-name" style="color: var(--text-muted);">... and ' + (illuminatedNodeIds.length - 8) + ' more nodes</span></div>';
    }
    document.getElementById('credentialNodes').innerHTML = nodesHTML;
  }

  // --- Share button ---
  document.getElementById('shareResultBtn').addEventListener('click', function() {
    scrollTo(shareSection);
  });
  document.getElementById('retakeBtn').addEventListener('click', function() {
    handleAssess();
  });
  document.getElementById('shareBtn').addEventListener('click', function() {
    var text = 'I scored Level ' + (window._assessResult ? window._assessResult.level : '?') +
      ' on SkillGarden! ' + window.location.href;
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(function() {
        document.getElementById('shareBtn').textContent = 'Copied!';
        setTimeout(function() {
          document.getElementById('shareBtn').innerHTML =
            '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg> Copy Share Link';
        }, 2000);
      });
    }
  });

  // --- Event wiring ---
  illuminateBtn.addEventListener('click', handleIlluminate);
  illuminateInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !illuminateBtn.disabled) handleIlluminate();
  });
  document.getElementById('resetBtn').addEventListener('click', handleReset);
  document.getElementById('assessBtn').addEventListener('click', handleAssess);

})();
</script>

</body>
</html>
